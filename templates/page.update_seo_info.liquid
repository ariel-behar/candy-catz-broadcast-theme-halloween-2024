{% if customer %}
  {% if customer.email == "unufri@gmail.com" %}
    <p>Permissions granted!</p>
    
    <p>Update SEO for Collections</p>

    {%- for collection in collections -%}
      {% assign meta_value = collection.metafields.custom.info %}
      {% if meta_value != blank %}
       
        {% assign json_string = collection.metafields.custom.info | json %}
{% assign json_string = json_string | remove_first: '[' | remove_last: ']' %}
{% assign json_items = json_string | split: '},' %}

        <h3>{{ collection.title }}</h3>

        
          <div id="collection-{{ collection.id }}">
            {% for item in json_items %}
              
              <fieldset style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
                <legend>Entry {{ forloop.index }}</legend>
                <label>URL: <input type="text" class="meta-input" data-key="url" value="{{ item.url }}" /></label><br>
                <label>H1: <input type="text" class="meta-input" data-key="h1" value="{{ item.h1 }}" /></label><br>
                <label>Meta Title: <input type="text" class="meta-input" data-key="meta_title" value="{{ item.meta_title }}" /></label><br>
                <label>Meta Description: <input type="text" class="meta-input" data-key="meta_description" value="{{ item.meta_description }}" /></label>
              </fieldset>
            {% endfor %}
          </div>

          <!-- Текстово поле за копиране на обновения JSON -->
          <label>Updated JSON:</label><br>
          <textarea id="json-output-{{ collection.id }}" rows="6" cols="60">{{ meta_value }}</textarea><br>
          <button type="button" onclick="updateJson({{ collection.id }})">Update JSON</button>
        

      {% endif %}
    {%- endfor -%}

    <script>

     document.addEventListener("DOMContentLoaded", function () {
    // Намираме всички textarea елементи, които съдържат JSON
    document.querySelectorAll("textarea[id^='json-output-']").forEach(textarea => {
        const collectionId = textarea.id.replace("json-output-", ""); // Извличаме ID на колекцията
        
        // Опитваме се да парснем JSON-а от textarea
        let jsonData;
        try {
            jsonData = JSON.parse(textarea.value);
        } catch (e) {
            console.error(`Invalid JSON for collection ${collectionId}:`, e);
            return; // Прекратяваме изпълнението за тази колекция
        }

        // Намираме контейнера, в който ще добавяме input полетата
        const inputContainer = document.createElement('div');
        inputContainer.classList.add("input-container");
        
        // Генерираме input полета за всеки запис в JSON масива
        jsonData.forEach((item, index) => {
            const fieldset = document.createElement('fieldset');
            fieldset.style.border = '1px solid #ccc';
            fieldset.style.padding = '10px';
            fieldset.style.marginBottom = '10px';
            
            const legend = document.createElement('legend');
            legend.textContent = `Entry ${index + 1}`;
            fieldset.appendChild(legend);

            // Генерираме input полета за всяко поле
            Object.keys(item).forEach(key => {
                const label = document.createElement('label');
                label.textContent = `${key.charAt(0).toUpperCase() + key.slice(1)}: `;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.classList.add('meta-input');
                input.setAttribute('data-key', key);
                input.value = item[key];
                input.addEventListener('input', updateTextarea);

                label.appendChild(input);
                fieldset.appendChild(label);
                fieldset.appendChild(document.createElement('br'));
            });

            inputContainer.appendChild(fieldset);
        });

        // Вмъкваме inputContainer преди textarea
        textarea.parentNode.insertBefore(inputContainer, textarea);

        // Функция за актуализиране на JSON в textarea при промяна на input полета
        function updateTextarea() {
            // Прочитаме стойностите от input полетата
            const updatedData = [];

         
         
            document.querySelectorAll(`#${textarea.id} ~ .input-container fieldset`).forEach((fieldset, index) => {
                const item = {};
                fieldset.querySelectorAll(".meta-input").forEach(input => {
                    const key = input.getAttribute('data-key');
                    item[key] = input.value;
                });
                updatedData.push(item);
            });

            // Актуализираме стойността на textarea
            textarea.value = JSON.stringify(updatedData, null, 2);
        }
    });
});
      
      function updateJson(collectionId) {
        let updatedData = [];
        let container = document.getElementById("collection-" + collectionId);
        let inputs = container.querySelectorAll(".meta-input");

        // Групиране на input стойностите в JSON
        let items = [];
        let fields = ["url", "h1", "meta_title", "meta_description"];
        inputs.forEach((input, index) => {
          let field = input.getAttribute("data-key");
          let itemIndex = Math.floor(index / fields.length); // Намерете кой запис се обработва

          if (!items[itemIndex]) {
            items[itemIndex] = {};
          }

          items[itemIndex][field] = input.value;
        });

        // Поставяне на актуализирания JSON в textarea
        document.getElementById("json-output-" + collectionId).value = JSON.stringify(items, null, 2);
      }
    </script>

  {% else %}
    <p>Permissions denied.</p>
  {% endif %}
{% else %}
  <p>Permissions denied.</p>
{% endif %}