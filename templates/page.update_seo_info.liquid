{% if customer %}
  {% if customer.email == "unufri@gmail.com" %}
    <p>Permissions granted!</p>
    
    <p>Update SEO for Collections</p>


    <div id="new-collection">
    <h3>Create New SEO data for Collection</h3>
    
    <textarea id=textarea_pasted></textarea>
    <!-- –§–æ—Ä–º–∞—Ç–∞ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ –∑–∞–ø–∏—Å -->
    <fieldset style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
        <legend>Entry</legend>
        <label>URL: <input type="text" id="url" class="meta-input" placeholder="Enter URL"></label><br>
        <label>H1: <input type="text" id="h1" class="meta-input" placeholder="Enter H1"></label><br>
        <label>Meta Title: <input type="text" id="meta_title" class="meta-input" placeholder="Enter Meta Title"></label><br>
        <label>Meta Description: <input type="text" id="meta_description" class="meta-input" placeholder="Enter Meta Description"></label>
    </fieldset>
<br />
     
    <!-- –ë—É—Ç–æ–Ω –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ –∑–∞–ø–∏—Å -->
    <button type="button" id="add-entry" style='background: #ffffff; color: #000000; padding: 5px;'>Add Entry</button><br /><br />

    <!-- –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏—è JSON –≤ textarea -->
    <textarea id="json-output" rows="6" cols="60" placeholder="Generated JSON will appear here..."></textarea>
    
    <!-- –ë—É—Ç–æ–Ω –∑–∞ –∫–æ–ø–∏—Ä–∞–Ω–µ –Ω–∞ JSON --><br />
    <button type="button" id="copy-json" style='background: #ffffff; color: #000000; padding: 5px;'>Copy Data</button>
</div>


    
    {%- for collection in collections -%}
      {% assign meta_value = collection.metafields.custom.info %}
      {% if meta_value != blank %}
       
        {% assign json_string = collection.metafields.custom.info | json %}
{% assign json_string = json_string | remove_first: '[' | remove_last: ']' %}
{% assign json_items = json_string | split: '},' %}

        <h3>{{ collection.title }}</h3>

        
          <div id="collection-{{ collection.id }}">


            
            
          </div>

         
        
          <!-- –¢–µ–∫—Å—Ç–æ–≤–æ –ø–æ–ª–µ –∑–∞ –∫–æ–ø–∏—Ä–∞–Ω–µ –Ω–∞ –æ–±–Ω–æ–≤–µ–Ω–∏—è JSON -->
          <label>Updated JSON:</label><br>
        

<br />
          <textarea id="json-output-{{ collection.id }}" rows="6" cols="60">{{ meta_value }}</textarea><br>
          
          <button type="button" id="copy-{{ collection.id }}" style='background: #ffffff; color: #000000; padding: 5px;'>Copy Data</button>
        <a href="https://admin.shopify.com/store/candycatz/bulk/collection?resource_name=Collection&query={{ collection.handle }}&ids={{ collection.id }}&edit=metafields.custom.info" target="_blank">üîó Edit Collection</a>

      {% endif %}
    {%- endfor -%}

    <script>

const storefrontAccessToken = "591f1d27a71a93806965dba696bfa85f";
const shopifyStore = "candycatz.myshopify.com";

async function getCollectionIdByHandle(handle) {
    const query = `
        {
            collectionByHandle(handle: "${handle}") {
                id
            }
        }
    `;

    const response = await fetch(`https://${shopifyStore}/api/2023-01/graphql.json`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-Shopify-Storefront-Access-Token": storefrontAccessToken
        },
        body: JSON.stringify({ query })
    });

    const data = await response.json();
    
  const gid = data.data.collectionByHandle?.id;
const collectionId = gid.split("/").pop(); 

  return collectionId;
  
}


      
function extractCollectionHandle(url) {
    const match = url.match(/\/collections\/([^/?]+)/);
    return match ? match[1] : null;
}
      
     document.addEventListener("DOMContentLoaded", function () {

       
       
       // –ú—è—Å—Ç–æ –∑–∞ —Å—ä—Ö—Ä–∞–Ω—è–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –∑–∞–ø–∏—Å–∏
   let entries = [];

      function cleanUrl(url) {
    const urlObject = new URL(url);
    return urlObject.origin + urlObject.pathname; // –í—Ä—ä—â–∞ —Å–∞–º–æ –æ—Å–Ω–æ–≤–Ω–∏—è URL –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—Ç–µ
}
       
// –ù–∞–º–∏—Ä–∞–º–µ –±—É—Ç–æ–Ω–∞ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ –∑–∞–ø–∏—Å
const addEntryButton = document.getElementById('add-entry');
const jsonOutputTextarea = document.getElementById('json-output');
const copyJsonButton = document.getElementById('copy-json');



// –§—É–Ω–∫—Ü–∏—è –∑–∞ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç–∞
function distributeText() {
    const text = document.getElementById('textarea_pasted').value; // –¢–µ–∫—Å—Ç–∞ –æ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ—Ç–æ –ø–æ–ª–µ

    // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ —Ä–µ–≥—É–ª—è—Ä–Ω–∏ –∏–∑—Ä–∞–∑–∏ –∑–∞ —Ä–∞–∑–¥–µ–ª—è–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç–∞
        const regex = /^(.+?)\s*\[H1\]\s*-\s*(.+?)\s*\[H1\]\s*by\s*(.+?)\s*FALSE\s*(https?:\/\/[^\s]+)/;


    const match = text.match(regex);

    if (match) {
        // –ê–∫–æ –Ω–∞–º–µ—Ä–∏–º —Å—ä–≤–ø–∞–¥–µ–Ω–∏–µ, —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–º–µ –≤ –ø–æ–ª–µ—Ç–∞—Ç–∞
        document.getElementById('h1').value = match[1]; // "Plus size gothic tops"
        document.getElementById('meta_title').value = '[H1] - ' + match[2]; // "[H1] - Candy Catz"
        document.getElementById('meta_description').value = '[H1] by ' + match[3]; // "[H1] by Candy Catz that will make you go wild..."
        document.getElementById('url').value = match[4]; // URL-—Ç–æ
    } else {
        alert("Text format does not match the expected structure.");
    }
}

// –î–æ–±–∞–≤—è–º–µ —Å—ä–±–∏—Ç–∏–µ –∑–∞ –ø–µ–π—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ—Ç–æ –ø–æ–ª–µ
document.getElementById('textarea_pasted').addEventListener('input', distributeText);

       
// –°—ä–±–∏—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫ –≤—ä—Ä—Ö—É –±—É—Ç–æ–Ω–∞ "Add Entry"
addEntryButton.addEventListener('click', function () {
    // –°—ä–±–∏—Ä–∞–º–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏—Ç–µ –æ—Ç input –ø–æ–ª–µ—Ç–∞—Ç–∞
    const url = document.getElementById('url').value;
    const h1 = document.getElementById('h1').value;
    let metaTitle = document.getElementById('meta_title').value;
    let metaDescription = document.getElementById('meta_description').value;

    // –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –¥–∞–ª–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞ —Å–∞ –ø–æ–ø—ä–ª–Ω–µ–Ω–∏
    if (!url || !h1 || !metaTitle || !metaDescription) {
        alert("Please fill in all fields.");
        return;
    }

  getCollectionIdByHandle(extractCollectionHandle(url)).then(collectionId => {
    
     const button = document.getElementById("copy-json");
 
    // –ê–∫–æ –≤–µ—á–µ –∏–º–∞ –ª–∏–Ω–∫, –ø—Ä–µ–º–∞—Ö–≤–∞–º–µ —Å—Ç–∞—Ä–∏—è
    const existingLink = document.getElementById("collection-link");
    if (existingLink) {
        existingLink.remove();
    }

    // –°—ä–∑–¥–∞–≤–∞–º–µ –Ω–æ–≤ <a> –µ–ª–µ–º–µ–Ω—Ç
    const link = document.createElement("a");
    link.id = "collection-link"; // –î–∞–≤–∞–º–µ ID, –∑–∞ –¥–∞ –Ω–µ –¥—É–±–ª–∏—Ä–∞–º–µ
    link.href = `https://admin.shopify.com/store/candycatz/bulk/collection?resource_name=Collection&query=all-dresses&ids=${collectionId}&edit=metafields.custom.info`;
    link.textContent = "üîó Edit Collection";
    link.target = "_blank"; // –û—Ç–≤–∞—Ä—è –ª–∏–Ω–∫–∞ –≤ –Ω–æ–≤ —Ç–∞–±
    link.style.display = "block"; // –ó–∞ –¥–∞ –µ –ø–æ–¥ –±—É—Ç–æ–Ω–∞
    link.style.marginTop = "10px"; // –ú–∞–ª–∫–æ —Ä–∞–∑—Å—Ç–æ—è–Ω–∏–µ

    // –î–æ–±–∞–≤—è–º–µ –ª–∏–Ω–∫–∞ —Å–ª–µ–¥ –±—É—Ç–æ–Ω–∞
    button.parentNode.insertBefore(link, button.nextSibling);
    
});
  

  
  
    
  // –ó–∞–º–µ–Ω—è–º–µ [H1] —Å —Ä–µ–∞–ª–Ω–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞ h1
metaTitle = metaTitle.replaceAll("[H1]", h1);
metaDescription = metaDescription.replaceAll("[H1]", h1);
  
//    https://admin.shopify.com/store/candycatz/bulk/collection?resource_name=Collection&query=all-dresses&ids=407269114110&edit=metafields.custom.info
    // –°—ä–∑–¥–∞–≤–∞–º–µ –Ω–æ–≤ –æ–±–µ–∫—Ç –∑–∞ –Ω–æ–≤–∏—è –∑–∞–ø–∏—Å
    const newEntry = {
        url: url,
        h1: h1,
        meta_title: metaTitle,
        meta_description: metaDescription
    };

    // –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –¥–∞–ª–∏ URL-—Ç–æ –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ –≤ –Ω—è–∫–æ–π –æ—Ç —Ç–µ–∫—Å—Ç–∞—Ä–µ–∏—Ç–µ
    const allTextareas = document.querySelectorAll('textarea[id^="json-output-"]');
    let found = false;
    allTextareas.forEach(textarea => {
        const existingData = JSON.parse(textarea.value || '[]');
        const existingEntry = existingData.find(entry => cleanUrl(entry.url) === cleanUrl(url));

        if (existingEntry) {
            // –ê–∫–æ URL-—Ç–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ –≤ —Ç–æ–∑–∏ textarea, –∫–æ–º–±–∏–Ω–∏—Ä–∞–º–µ —Å—Ç–∞—Ä–∏—è –∏ –Ω–æ–≤–∏—è –∑–∞–ø–∏—Å
            existingData.push(newEntry); // –î–æ–±–∞–≤—è–º–µ –Ω–æ–≤–∏—è –∑–∞–ø–∏—Å
            jsonOutputTextarea.value = JSON.stringify(existingData, null, 2); // –û–±–Ω–æ–≤—è–≤–∞–º–µ —Å—ä–æ—Ç–≤–µ—Ç–Ω–∏—è textarea
            found = true; // –û—Ç–±–µ–ª—è–∑–≤–∞–º–µ, —á–µ –∑–∞–ø–∏—Å—ä—Ç –µ –Ω–∞–º–µ—Ä–µ–Ω –∏ –¥–æ–±–∞–≤–µ–Ω
        }
    });

    // –ê–∫–æ URL-—Ç–æ –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ –≤ –Ω–∏–∫–æ—è —Ç–µ–∫—Å—Ç–∞—Ä–µ—è, –¥–æ–±–∞–≤—è–º–µ –≥–æ –≤ —Ç–µ–∫—É—â–∏—è textarea
    if (!found) {
        entries.push(newEntry); // –î–æ–±–∞–≤—è–º–µ –Ω–æ–≤–∏—è –∑–∞–ø–∏—Å –∫—ä–º —Ç–µ–∫—É—â–∏—è –º–∞—Å–∏–≤ –æ—Ç –∑–∞–ø–∏—Å–∏
        jsonOutputTextarea.value = JSON.stringify(entries, null, 2); // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–º–µ —Ç–µ–∫—É—â–∏—è textarea
    }

    // –ü–æ—á–∏—Å—Ç–≤–∞–º–µ input –ø–æ–ª–µ—Ç–∞—Ç–∞ –∑–∞ —Å–ª–µ–¥–≤–∞—â–∏—è –∑–∞–ø–∏—Å
    document.getElementById('url').value = '';
    document.getElementById('h1').value = '';
    document.getElementById('meta_title').value = '';
    document.getElementById('meta_description').value = '';
});

    // –°—ä–±–∏—Ç–∏–µ –∑–∞ –∫–æ–ø–∏—Ä–∞–Ω–µ –Ω–∞ JSON –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞
    copyJsonButton.addEventListener('click', function () {
        // –ò–∑–±–∏—Ä–∞–º–µ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –Ω–∞ textarea
        jsonOutputTextarea.select();
        jsonOutputTextarea.setSelectionRange(0, 99999); // –ó–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

        // –ö–æ–ø–∏—Ä–∞–º–µ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞
        try {
            // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ –Ω–æ–≤–∏—è Clipboard API –∑–∞ –¥–∞ –∫–æ–ø–∏—Ä–∞–º–µ —Ç–µ–∫—Å—Ç–∞
            navigator.clipboard.writeText(jsonOutputTextarea.value).then(() => {
                //alert('JSON copied to clipboard!');
            }).catch(err => {
                console.error('Error copying text: ', err);
                alert('Failed to copy data');
            });
        } catch (err) {
            console.error('Error copying text: ', err);
        }
    });
       
    // –ù–∞–º–∏—Ä–∞–º–µ –≤—Å–∏—á–∫–∏ textarea –µ–ª–µ–º–µ–Ω—Ç–∏, –∫–æ–∏—Ç–æ —Å—ä–¥—ä—Ä–∂–∞—Ç JSON
    document.querySelectorAll("textarea[id^='json-output-']").forEach(textarea => {
        const collectionId = textarea.id.replace("json-output-", ""); // –ò–∑–≤–ª–∏—á–∞–º–µ ID –Ω–∞ –∫–æ–ª–µ–∫—Ü–∏—è—Ç–∞
        
        // –û–ø–∏—Ç–≤–∞–º–µ —Å–µ –¥–∞ –ø–∞—Ä—Å–Ω–µ–º JSON-–∞ –æ—Ç textarea
        let jsonData;
        try {
            jsonData = JSON.parse(textarea.value);
        } catch (e) {
            console.error(`Invalid JSON for collection ${collectionId}:`, e);
            return; // –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–º–µ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ—Ç–æ –∑–∞ —Ç–∞–∑–∏ –∫–æ–ª–µ–∫—Ü–∏—è
        }

        // –ù–∞–º–∏—Ä–∞–º–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ –∫–æ–ª–µ–∫—Ü–∏—è—Ç–∞ (div —Å id collection-{{ collection.id }})
        const collectionContainer = document.getElementById(`collection-${collectionId}`);
        
        // –ù–∞–º–∏—Ä–∞–º–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –≤ –∫–æ–π—Ç–æ —â–µ –¥–æ–±–∞–≤—è–º–µ input –ø–æ–ª–µ—Ç–∞—Ç–∞
        const inputContainer = document.createElement('div');
        inputContainer.classList.add("input-container");

        // –ì–µ–Ω–µ—Ä–∏—Ä–∞–º–µ input –ø–æ–ª–µ—Ç–∞ –∑–∞ –≤—Å–µ–∫–∏ –∑–∞–ø–∏—Å –≤ JSON –º–∞—Å–∏–≤–∞
        jsonData.forEach((item, index) => {
            const fieldset = document.createElement('fieldset');
            fieldset.style.border = '1px solid #ccc';
            fieldset.style.padding = '10px';
            fieldset.style.marginBottom = '10px';
            
            const legend = document.createElement('legend');
            legend.textContent = `Entry ${index + 1}`;
            fieldset.appendChild(legend);

            // –ì–µ–Ω–µ—Ä–∏—Ä–∞–º–µ input –ø–æ–ª–µ—Ç–∞ –∑–∞ –≤—Å—è–∫–æ –ø–æ–ª–µ
            Object.keys(item).forEach(key => {
                const label = document.createElement('label');
                label.textContent = `${key.charAt(0).toUpperCase() + key.slice(1)}: `;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.classList.add('meta-input');
                input.setAttribute('data-key', key);
                input.value = item[key];
                input.addEventListener('input', () => updateTextarea(collectionId));  // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–º–µ —Å–∞–º–æ —Ç–µ–∫—É—â–∏—è textarea

                label.appendChild(input);
                fieldset.appendChild(label);
                fieldset.appendChild(document.createElement('br'));
            });

            inputContainer.appendChild(fieldset);
        });

        // –í–º—ä–∫–≤–∞–º–µ inputContainer –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ –∫–æ–ª–µ–∫—Ü–∏—è—Ç–∞ (–ø—Ä–µ–¥–∏ —Å–∞–º–∏—è textarea)
        collectionContainer.appendChild(inputContainer);

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ JSON –≤ textarea –ø—Ä–∏ –ø—Ä–æ–º—è–Ω–∞ –Ω–∞ input –ø–æ–ª–µ—Ç–∞
        function updateTextarea(collectionId) {
            const textarea = document.getElementById(`json-output-${collectionId}`); // –ù–∞–º–∏—Ä–∞–º–µ —Å—ä–æ—Ç–≤–µ—Ç–Ω–∏—è textarea

            // –ü—Ä–æ—á–∏—Ç–∞–º–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏—Ç–µ –æ—Ç input –ø–æ–ª–µ—Ç–∞—Ç–∞ —Å–∞–º–æ –≤ —Ä–∞–º–∫–∏—Ç–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑–∞ —Ç–∞–∑–∏ –∫–æ–ª–µ–∫—Ü–∏—è
            const updatedData = [];

            collectionContainer.querySelectorAll('.input-container fieldset').forEach((fieldset) => {
                const item = {};
                fieldset.querySelectorAll(".meta-input").forEach(input => {
                  
                    const key = input.getAttribute('data-key');
                    item[key] = input.value;
                
                });
                updatedData.push(item);
            });

            // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–º–µ —Å—Ç–æ–π–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ textarea
            textarea.value = JSON.stringify(updatedData, null, 2);
        }

      const copyButton = document.getElementById(`copy-${collectionId}`);
        if (copyButton) {
            copyButton.addEventListener("click", function () {
                const textarea = document.getElementById(`json-output-${collectionId}`);
                if (textarea) {
                    // –ò–∑–±–∏—Ä–∞–º–µ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –Ω–∞ textarea
                    textarea.select();
                    textarea.setSelectionRange(0, 99999); // –ó–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

                    // –ö–æ–ø–∏—Ä–∞–º–µ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞
                    try {
                        document.execCommand('copy');
                        alert('Data copied to clipboard!');
                    } catch (err) {
                        console.error('Unable to copy text', err);
                    }
                }
            });
        }
      
    });
});

      
      function updateJson(collectionId) {
        let updatedData = [];
        let container = document.getElementById("collection-" + collectionId);
        let inputs = container.querySelectorAll(".meta-input");

        // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ input —Å—Ç–æ–π–Ω–æ—Å—Ç–∏—Ç–µ –≤ JSON
        let items = [];
        let fields = ["url", "h1", "meta_title", "meta_description"];
        inputs.forEach((input, index) => {
          let field = input.getAttribute("data-key");
          let itemIndex = Math.floor(index / fields.length); // –ù–∞–º–µ—Ä–µ—Ç–µ –∫–æ–π –∑–∞–ø–∏—Å —Å–µ –æ–±—Ä–∞–±–æ—Ç–≤–∞

          if (!items[itemIndex]) {
            items[itemIndex] = {};
          }

          items[itemIndex][field] = input.value;
        });

        // –ü–æ—Å—Ç–∞–≤—è–Ω–µ –Ω–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–∏—è JSON –≤ textarea
        document.getElementById("json-output-" + collectionId).value = JSON.stringify(items, null, 2);
      }
    </script>

  {% else %}
    <p>Permissions denied.</p>
  {% endif %}
{% else %}
  <p>Permissions denied.</p>
{% endif %}